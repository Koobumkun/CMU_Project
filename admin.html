<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Recycle Battery Management</title>
    <link rel="stylesheet" href="admin.css" />
  </head>
  <body>
    <div class="container">
      <!-- Sidebar -->
      <div class="sidebar">
        <!-- Logo Section -->
        <div class="logo-section">
          <a href="./login.html">
            <img
              src="./images/system_logo.png"
              alt="Battery Icon"
              class="logo-icon"
            />
            <h2>Lithium Loop</h2>
          </a>
        </div>
        <!-- Menu Section -->
        <nav class="menu-section">
          <img src="./images/admin.jpg" alt="Company Logo" class="admin-logo" />
          <span id="user-name">Admin</span>
          <ul>
            <div class="menu-item selected">
              <img
                src="./images/dashboard.png"
                alt="management_icon"
                class="management-logo"
              />
              <li>Management</li>
            </div>
          </ul>
        </nav>
      </div>

      <!-- Main Content -->
      <main class="main-content">
        <h1>Management</h1>

        <!-- Our Batteries -->
        <section class="section">
          <h2>Our Batteries</h2>
          <table>
            <thead>
              <tr>
                <th>Type</th>
                <th>Amount</th>
                <th>Cost per one</th>
                <th>Costs</th>
              </tr>
            </thead>
            <tbody id="battery-data"></tbody>
          </table>
        </section>

        <!-- Selling Requests -->
        <section class="section">
          <h2>Selling Requests</h2>
          <table>
            <thead>
              <tr>
                <th>Status</th>
                <th>Type</th>
                <th>Date</th>
                <th>Address</th>
                <th>Amount</th>
                <th>Cost</th>
                <th>Apply</th>
              </tr>
            </thead>
            <tbody id="selling-requests-data"></tbody>
          </table>
        </section>

        <!-- Purchasing Requests -->
        <section class="section">
          <h2>Purchasing Requests</h2>
          <table>
            <thead>
              <tr>
                <th>Status</th>
                <th>Type</th>
                <th>Company</th>
                <th>Date</th>
                <th>Amount</th>
                <th>Cost</th>
                <th>Apply</th>
              </tr>
            </thead>
            <tbody id="purchasing-requests-data"></tbody>
          </table>
        </section>
      </main>
    </div>
  </body>
  <script>
    // 로컬스토리지에서 데이터 가져오기
    function getBatteriesFromLocalStorage() {
      const batteries = localStorage.getItem("batteries");
      return batteries ? JSON.parse(batteries) : [];
    }

    // 로컬스토리지에서 데이터 가져오기
    function getSellingRequestsFromLocalStorage() {
      const requests = localStorage.getItem("selling_requests");
      return requests ? JSON.parse(requests) : [];
    }

    // 로컬스토리지에서 데이터 가져오기
    function getPurchasingRequestsFromLocalStorage() {
      const requests = localStorage.getItem("purchasing_requests");
      return requests ? JSON.parse(requests) : [];
    }

    // 데이터를 렌더링하는 함수
    function renderBatteries(data) {
      const tbody = document.getElementById("battery-data");
      tbody.innerHTML = ""; // 기존 내용을 비우기

      data.forEach((battery) => {
        const row = document.createElement("tr");

        // 각 데이터 값을 셀에 추가
        for (const key in battery) {
          const cell = document.createElement("td");
          if (key === "Total_Cost" || key === "Cost_per") {
            cell.textContent = `${battery[key]}$`;
          } else {
            cell.textContent = battery[key];
          }
          row.appendChild(cell);
        }

        tbody.appendChild(row);
      });
    }

    function renderSellingRequests(data) {
      const tbody = document.getElementById("selling-requests-data");
      tbody.innerHTML = ""; // 기존 내용을 비우기

      data.forEach((request) => {
        const row = document.createElement("tr");

        // Status 컬럼 추가
        const statusCell = document.createElement("td");
        statusCell.textContent = request.accept ? `✅ Complete` : `⏳ Waiting`;
        row.appendChild(statusCell);

        // 다른 필드 추가
        for (const key in request) {
          if (key === "accept") continue; // accept는 버튼으로 처리

          const cell = document.createElement("td");

          if (key === "costs") {
            // Cost 필드에 단위 추가
            cell.textContent = `${request[key]}$`;
          } else {
            cell.textContent = request[key];
          }

          row.appendChild(cell);
        }

        // Accept 버튼 추가
        const actionCell = document.createElement("td");
        const button = document.createElement("button");
        button.textContent = request.accept ? "수락완료" : "수락";
        button.className = request.accept ? "disabled-button" : "action-button";
        button.disabled = request.accept;

        // 버튼 클릭 이벤트
        button.addEventListener("click", () => handleAccept(request));

        actionCell.appendChild(button);
        row.appendChild(actionCell);

        tbody.appendChild(row);
      });
    }

    function renderPurchasingRequests(data) {
      const tbody = document.getElementById("purchasing-requests-data");
      tbody.innerHTML = ""; // 기존 내용을 비우기

      data.forEach((request) => {
        const row = document.createElement("tr");

        // Accept 상태에 따라 Status 추가
        const statusCell = document.createElement("td");
        statusCell.textContent = request.accept ? "✅ Complete" : "⏳ Waiting";
        row.appendChild(statusCell);

        // 나머지 데이터 필드 추가
        for (const key in request) {
          if (key === "accept") continue; // accept는 Status로 처리

          const cell = document.createElement("td");
          if (key === "costs") {
            // Cost 필드에 단위 추가
            cell.textContent = `${request[key]}$`;
          } else {
            cell.textContent = request[key];
          }
          row.appendChild(cell);
        }

        // Accept 버튼 추가
        const actionCell = document.createElement("td");
        const button = document.createElement("button");
        button.textContent = request.accept ? "수락완료" : "수락";
        button.className = request.accept ? "disabled-button" : "action-button";
        button.disabled = request.accept;

        // 버튼 클릭 이벤트
        button.addEventListener("click", () => handlePurchaseAccept(request));

        actionCell.appendChild(button);
        row.appendChild(actionCell);

        tbody.appendChild(row);
      });
    }

    // 현재 로그인된 사용자 정보 렌더링
    function renderUserName() {
      const currentUser = JSON.parse(localStorage.getItem("current_login"));

      if (currentUser && currentUser.name) {
        document.getElementById("user-name").textContent = currentUser.name;
      } else {
        document.getElementById("user-name").textContent = "Guest";
      }
    }

    function handleAccept(request) {
      // 요청 상태 변경
      request.accept = true;

      // 로컬스토리지 업데이트
      const requests = getSellingRequestsFromLocalStorage();
      const updatedRequests = requests.map((r) =>
        r.date === request.date && r.type === request.type ? request : r
      );
      localStorage.setItem("selling_requests", JSON.stringify(updatedRequests));

      // 테이블 다시 렌더링
      renderSellingRequests(updatedRequests);
    }

    function handlePurchaseAccept(request) {
      // 요청 상태 변경
      request.accept = true;

      // 로컬스토리지 업데이트
      const requests = getPurchasingRequestsFromLocalStorage();
      const updatedRequests = requests.map((r) =>
        r.date === request.date && r.type === request.type ? request : r
      );
      localStorage.setItem(
        "purchasing_requests",
        JSON.stringify(updatedRequests)
      );

      // 테이블 다시 렌더링
      renderPurchasingRequests(updatedRequests);
    }

    document.querySelectorAll(".menu-item").forEach((item) => {
      item.addEventListener("click", () => {
        // 모든 메뉴 항목에서 `selected` 클래스 제거
        document.querySelectorAll(".menu-item").forEach((menu) => {
          menu.classList.remove("selected");
        });

        // 클릭된 항목에 `selected` 클래스 추가
        item.classList.add("selected");
      });
    });

    // 초기화 시 실행
    document.addEventListener("DOMContentLoaded", () => {
      renderUserName(); // 유저 이름 렌더링

      const batteries = getBatteriesFromLocalStorage();
      renderBatteries(batteries);

      const requests = getSellingRequestsFromLocalStorage();
      renderSellingRequests(requests);

      const purchasingRequests = getPurchasingRequestsFromLocalStorage();
      renderPurchasingRequests(purchasingRequests);
    });
  </script>
</html>
